# Agendamento de Cortes — Projeto Completo

Neste documento estão os arquivos para rodar o site **online** com painel administrativo protegido (apenas você pode adicionar/excluir horários). Vou fornecer tudo: backend (Node.js + SQLite), frontend público (consulta de horários) e painel admin (login simples com senha). Também há instruções de deploy.

---

## Estrutura do projeto

```
agendamento-cortes/
├─ server.js            <-- API + autenticação JWT simples
├─ package.json
├─ db.sqlite            <-- criado automaticamente ao rodar (SQLite)
├─ migrations.sql       <-- criação da tabela
├─ public/
│  ├─ index.html        <-- frontend público (ver horários)
│  └─ admin.html        <-- painel administrativo (login + CRUD)
└─ .env.example         <-- variáveis de ambiente
```

---

## 1) `package.json`
Use o Node 18+.

```json
{
  "name": "agendamento-cortes",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "better-sqlite3": "^8.0.0",
    "cors": "^2.8.5",
    "dotenv": "^16.0.0",
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.0",
    "body-parser": "^1.20.2"
  }
}
```

---

## 2) `migrations.sql`
Cria a tabela de `slots` e `bookings`.

```sql
CREATE TABLE IF NOT EXISTS slots (
  id TEXT PRIMARY KEY,
  date TEXT NOT NULL,
  time TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS bookings (
  id TEXT PRIMARY KEY,
  slot_id TEXT NOT NULL,
  client_name TEXT,
  notes TEXT,
  created_at INTEGER,
  FOREIGN KEY(slot_id) REFERENCES slots(id) ON DELETE CASCADE
);
```

---

## 3) `server.js` — API, auth e administração

**Descrição rápida:**
- Rota pública `GET /api/slots` — lista slots com info de reserva (se houver).
- Rotas protegidas (bearer token) para `POST /api/slots`, `DELETE /api/slots/:id`, `POST /api/bookings` (opcional), etc.
- Rota `POST /api/login` aceita a senha administrativa (variável `ADMIN_PASSWORD`) e retorna um JWT.

> Coloque o arquivo `server.js` na raiz do projeto.

```js
// server.js
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const jwt = require('jsonwebtoken');
const Database = require('better-sqlite3');
const crypto = require('crypto');

const app = express();
app.use(cors());
app.use(bodyParser.json());
app.use(express.static('public'));

const DB_FILE = process.env.DATABASE_FILE || 'db.sqlite';
const db = new Database(DB_FILE);

// run migrations
const fs = require('fs');
if (fs.existsSync('migrations.sql')) {
  const sql = fs.readFileSync('migrations.sql','utf8');
  db.exec(sql);
}

const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || 'trocar_esta_senha';
const JWT_SECRET = process.env.JWT_SECRET || 'trocar_este_segredo';
const SALON_NUMBER = process.env.SALON_NUMBER || '5521998383301';

// helpers
function requireAuth(req,res,next){
  const h = req.headers.authorization;
  if(!h || !h.startsWith('Bearer ')) return res.status(401).json({error:'no token'});
  const token = h.split(' ')[1];
  try{ const payload = jwt.verify(token, JWT_SECRET); req.admin = payload; next(); }catch(e){ return res.status(401).json({error:'invalid token'}) }
}

// public: list all slots with booking (if exists)
app.get('/api/slots', (req,res)=>{
  const rows = db.prepare(`SELECT s.id, s.date, s.time, b.client_name, b.notes FROM slots s LEFT JOIN bookings b ON s.id=b.slot_id ORDER BY s.date, s.time`).all();
  res.json(rows);
});

// admin: create slot
app.post('/api/slots', requireAuth, (req,res)=>{
  const { date, time } = req.body;
  if(!date||!time) return res.status(400).json({error:'missing'});
  const id = crypto.randomBytes(8).toString('hex');
  const stmt = db.prepare('INSERT INTO slots(id,date,time) VALUES(?,?,?)');
  stmt.run(id,date,time);
  res.json({id,date,time});
});

// admin: delete slot (and its booking)
app.delete('/api/slots/:id', requireAuth, (req,res)=>{
  const id = req.params.id;
  const delb = db.prepare('DELETE FROM bookings WHERE slot_id=?');
  delb.run(id);
  const del = db.prepare('DELETE FROM slots WHERE id=?');
  const info = del.run(id);
  if(info.changes) return res.json({ok:true});
  res.status(404).json({error:'not found'});
});

// admin: create booking for a slot (optional)
app.post('/api/bookings', requireAuth, (req,res)=>{
  const { slot_id, client_name, notes } = req.body;
  if(!slot_id||!client_name) return res.status(400).json({error:'missing'});
  const id = crypto.randomBytes(8).toString('hex');
  const created_at = Date.now();
  const stmt = db.prepare('INSERT INTO bookings(id,slot_id,client_name,notes,created_at) VALUES(?,?,?,?,?)');
  stmt.run(id,slot_id,client_name,notes,created_at);
  // Optionally, send a WhatsApp link back (client can open it)
  const msg = `Nova reserva:
Cliente: ${client_name}
Horário ID: ${slot_id}
Observações: ${notes || ''}`;
  res.json({ok:true,booking:{id,slot_id,client_name,notes,created_at}, whatsapp:`https://wa.me/${SALON_NUMBER}?text=${encodeURIComponent(msg)}`});
});

// admin login
app.post('/api/login', (req,res)=>{
  const { password } = req.body;
  if(!password) return res.status(400).json({error:'missing'});
  if(password !== ADMIN_PASSWORD) return res.status(401).json({error:'invalid'});
  const token = jwt.sign({role:'admin'}, JWT_SECRET, { expiresIn:'12h' });
  res.json({ token });
});

// serve
const PORT = process.env.PORT || 3000;
app.listen(PORT, ()=>console.log('Server listening on',PORT));
```

---

## 4) `public/index.html` (frontend público)
Página simples que lista horários e mostra quem reservou (se houver).

```html
<!-- public/index.html -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Horários — Agendamento</title>
</head>
<body>
  <h1>Horários</h1>
  <div id="list"></div>
  <script>
    async function load(){
      const r = await fetch('/api/slots');
      const data = await r.json();
      const el = document.getElementById('list');
      el.innerHTML = data.map(s=>`<div><strong>${s.date} ${s.time}</strong> - ${s.client_name?('Reservado por '+s.client_name):'Disponível'}</div>`).join('');
    }
    load();
  </script>
</body>
</html>
```

---

## 5) `public/admin.html` (painel administrativo — login + CRUD)
Painel simples que pede a senha (não coloque a senha no HTML em produção). Após login ele guarda token no `localStorage` e usa para chamadas protegidas.

```html
<!-- public/admin.html -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel Admin — Agendamentos</title>
<style>body{font-family:Arial;padding:12px}label{display:block;margin-top:8px}input,select,button{padding:8px;margin-top:6px;width:100%}</style>
</head>
<body>
  <h1>Painel Administrativo</h1>

  <div id="login">
    <label>Senha administrativa:<input type="password" id="pwd"></label>
    <button onclick="login()">Entrar</button>
  </div>

  <div id="app" style="display:none">
    <h2>Adicionar horário</h2>
    <label>Data:<input id="date" type="date"></label>
    <label>Hora:<input id="time" type="time"></label>
    <button onclick="addSlot()">Adicionar</button>

    <h2>Horários</h2>
    <div id="slots"></div>
  </div>

<script>
const API = '/api';
function setToken(t){ localStorage.setItem('admin_token',t); }
function getToken(){ return localStorage.getItem('admin_token'); }

async function login(){ const pwd=document.getElementById('pwd').value; const r=await fetch(API+'/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({password:pwd})});
  if(r.ok){ const j=await r.json(); setToken(j.token); showApp(); loadSlots(); } else { alert('Senha inválida') }}

function showApp(){ document.getElementById('login').style.display='none'; document.getElementById('app').style.display='block'; }

async function addSlot(){ const date=document.getElementById('date').value; const time=document.getElementById('time').value; if(!date||!time) return alert('Preencha');
  const r = await fetch(API+'/slots',{method:'POST',headers:{'content-type':'application/json','authorization':'Bearer '+getToken()},body:JSON.stringify({date,time})});
  if(r.ok) { loadSlots(); } else { alert('Erro') }}

async function deleteSlot(id){ if(!confirm('Excluir este horário?')) return; const r=await fetch(API+'/slots/'+id,{method:'DELETE',headers:{authorization:'Bearer '+getToken()}}); if(r.ok) loadSlots(); else alert('erro') }

async function loadSlots(){ const r = await fetch(API+'/slots'); const data = await r.json(); const out = data.map(s=>{
  const id = s.id || (s.date+' '+s.time);
  const booked = s.client_name ? true : false;
  return `<div style="margin-bottom:8px;padding:8px;border:1px solid #ddd">`+
    `<strong>${s.date} ${s.time}</strong><div>${booked?('Reservado: '+s.client_name):'Disponível'}</div>`+
    `<div style="margin-top:6px"><button onclick="deleteSlot('${id}')">Excluir</button></div></div>`;
}).join('');
  document.getElementById('slots').innerHTML = out;
}

// init: check token
if(getToken()) { showApp(); loadSlots(); }
</script>
</body>
</html>
```

---

## 6) `.env.example`

```
ADMIN_PASSWORD=Alexmello1!
JWT_SECRET=16071999
DATABASE_FILE=db.sqlite
PORT=3000
SALON_NUMBER=5521998383301
```

---

## Como rodar localmente
1. Copie os arquivos em uma pasta.
2. `npm install`
3. Ajuste `.env` com `ADMIN_PASSWORD` e `JWT_SECRET` (importante).
4. `node server.js`
5. Abra `http://localhost:3000` (frontend público) e `http://localhost:3000/admin.html` (painel admin).

---

## Como deixar online (resumo das etapas)
1. Suba o repositório para um GitHub/GitLab.
2. Escolha um serviço (Render, Railway, Vercel, DigitalOcean App Platform). **Qualquer um que aceite Node.js** serve.
3. Configure variáveis de ambiente no painel do serviço (`ADMIN_PASSWORD`, `JWT_SECRET`, `SALON_NUMBER`).
4. Configure um volume persistente ou use o arquivo SQLite no serviço (muitos suportam volume). Se preferir, troque para um banco gerenciado (Postgres) e ajuste `server.js`.

Se quiser, eu posso:
- Gerar os arquivos finais aqui (colocar no canvas) — já estão nesta página.
- Gerar um `Dockerfile` para facilitar o deploy.
- Preparar instruções passo-a-passo para **Render** ou **Railway** com as telas e variáveis (me diga qual prefere) — faço isso agora sem precisar que você espere.

---

## Observações de segurança
- Não deixe `ADMIN_PASSWORD` ou `JWT_SECRET` no código público.
- Use senhas fortes e guarde o token com segurança (o painel usa `localStorage`).
- Para produção, use HTTPS e, se possível, limite IPs que podem acessar o painel.

---

Se quiser que eu gere agora o `Dockerfile` e o `README.md` com passos para deploy em Render ou Railway, eu já adiciono aqui.
